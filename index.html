<html>
<head>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
    
    var proxyUrl = "proxy.php";
    var currentPage = 0;
    var rows = 0;
    var cols = 0;
    var links = [];

    $(document).ready(function(){
        pageWidth = $(window).innerWidth();
        pageHeight = $(window).innerHeight();
        cellWidth = $('#list div.first').outerWidth() + 5; // padding
        cellHeight = $('#list div.first').outerHeight() + 5;

        // How many rows and columns?
        rows = Math.round(pageWidth / cellWidth);
        cols = Math.round(pageHeight/ cellHeight); 

        // 100 Results per page
        loadPage(currentPage);
    });

    function loadPage(pageNum){
        var args;

        if (pageNum == 0){
            // The first time through, we'll use the RSS feed.  It's way faster.
            args = "";
            datatype = 'xml';
            parseFunction = parseXML;
        } else {
            // Otherwise, we'll have to parse HTML.  Ugh
            args = "?page=" + pageNum * 100;
            datatype = 'html';
            parseFunction = parseHTML;
        }

        $('#list .image.moar').remove();

        $.ajax({
            url: proxyUrl + args,
            type: "GET",
            dataType: datatype, 
            success: parseFunction
        })
    }

    function parseXML(xml){
        $(xml).find("description").each(function(){
            url = $(this).prev().text();
            raw = $(this).text();
            markup = "<div>" + $.trim(raw) + "</div>";
            $(markup).find('img').each(function(){
                links.push({
                    'id': 0, 
                    'img' : $(this).attr('src'),
                    'url' : url
                });
            });
        }); 
        parseLinks(links, 0);
    }
    
    function parseHTML(html){
        pages = [];
        $(html).find('p.row a').each(function(){
            url = $(this).attr('href');
            arr = url.split('/');
            if (arr[5]){
                id = arr[5].split('.')[0];
                pages.push({
                    'id': id,
                });
            }
        }); 
        parsePages(pages, 0);
    }

    function parsePages(pages, i){
        if (pages.length > i){
        
            args = '?id=' + pages[i].id;
            $.ajax({
                url: proxyUrl + args,
                type: "GET",
                dataType: "html",
                success: function(html){
                    getLinks(html);
                    parsePages(pages, i+1);
                }
            });
        }
    }

    function getLinks(html, url){
        return;
        links = [];
        $(html).find('img').each(function(){
            links.push({
                'id': 0,
                'img': $(this).attr('src'),
                'url': "null"
            });
        });
    }

    function parseLinks(links, i){
        console.log(links);
        if (links.length > i){
            imgSrc = links[i].img;

            link = $('<a href="' + links[i].url + '"></a>')
                .click(function(evt){
                    //evt.preventDefault();
                });

            image = $('<img id="img-' + i + '" src="' + imgSrc +'" />')
                .css({'opacity': 0})
                .load(function(evt){
                    $('#img-' + i)
                        .animate({'opacity': 1}, 120)
                    parseLinks(links, i+1); 
                }).error(function(evt){
                    parseLinks(links, i+1);
                });

            container = $('<div class="image"></div>');
            $('#list').append(container.append(link.append(image)));
        } else {
            links = [];
            var moar = $('<div class="image moar"><a href="javascript:void(0)">Moar</a></div>')
                .click(function(evt){
                    evt.preventDefault()
                    currentPage++;
                    loadPage(currentPage);
                });
            $('#list').append(moar);
        }
    }


</script>

<style>

#list div.image {
    display:inline;
    height: 128px;
    width: 128px;
    overflow: hidden;
    float: left;
    padding: 5px;
}

#list div.image img{
    max-height: 100%;
    max-width: 100%;
}

#list div.image.first{
    display:none;
}

#list div.image.moar{
    font-size: 20px;
    text-align: center;
}

</style>
</head>
<body>
<ul id="list">
    <div class="image first"></div>
</ul>
</body>
</html>

